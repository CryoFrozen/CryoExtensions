<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cryo Extensions</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
      color: white;
      font-family: 'Roboto', sans-serif;
      overflow: hidden;
    }
    body {
      display: flex;
      flex-direction: column;
    }
    header {
      position: relative;
      display: flex;
      align-items: center;
      padding: 15px 60px;
      border-bottom: 1px solid #444;
      background-color: #111;
    }
    #logo {
      width: 40px;
      height: 40px;
      margin-right: 20px;
      transition: transform 0.3s ease;
    }
    #logo:hover {
      transform: scale(1.1);
    }
    #logo[src=""] {
      display: none;
    }
    #searchBar {
      width: 350px;
      padding: 10px 15px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      background: #333;
      color: white;
    }
    #searchBar:focus {
      outline: none;
      box-shadow: 0 0 5px #00aaff;
    }
    #settingsBtn {
      position: absolute;
      right: 15px;
      top: 15px;
      background-color: #00aaff;
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    #settingsBtn:hover {
      background-color: #0088cc;
    }
    #settingsPanel {
      position: fixed;
      top: 50px;
      right: 15px;
      background-color: #222;
      border: 1px solid #555;
      border-radius: 8px;
      padding: 15px 20px;
      display: none;
      z-index: 100;
      width: 220px;
      color: white;
    }
    #settingsPanel label {
      display: block;
      margin-bottom: 10px;
      cursor: pointer;
    }
    main {
      flex: 1;
      overflow-y: auto;
      padding: 30px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .extension-card {
      background-color: #222;
      border-radius: 12px;
      width: 280px;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s ease;
    }
    .extension-card:hover {
      transform: translateY(-5px);
    }
    .thumbnail {
      width: 100%;
      height: 160px;
      object-fit: contain;
      border-radius: 6px;
      background-color: #111;
      margin-bottom: 15px;
    }
    .description {
      font-size: 15px;
      margin-bottom: 15px;
      white-space: pre-wrap;
      min-height: 80px;
      text-align: center;
      color: #ccc;
    }
    button.action-btn {
      background: linear-gradient(90deg, #00aaff, #0088cc);
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
      width: 100%;
      transition: transform 0.2s ease;
    }
    button.action-btn:hover {
      transform: scale(1.05);
    }
    button.action-btn:disabled {
      background: #666;
      cursor: not-allowed;
    }
    .hidden {
      display: none;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #00aaff;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    main::-webkit-scrollbar {
      width: 10px;
    }
    main::-webkit-scrollbar-track {
      background: #111;
    }
    main::-webkit-scrollbar-thumb {
      background-color: #444;
      border-radius: 10px;
      border: 2px solid #111;
    }
  </style>
</head>
<body>
  <header>
    <img id="logo" src="" alt="Gallery Logo" onerror="console.log('Logo image load failed')">
    <input type="search" id="searchBar" placeholder="Search extensions..." />
    <button id="settingsBtn" title="Settings ⚙️">⚙️</button>
    <div id="settingsPanel">
      <strong>Get extension by:</strong>
      <label><input type="radio" name="getMethod" value="download" checked /> Download</label>
      <label><input type="radio" name="getMethod" value="copyContent" /> Copy JS Content</label>
      <label><input type="radio" name="getMethod" value="copyUrl" /> Copy URL</label>
    </div>
  </header>
  <main id="extensionsContainer">
    <div class="spinner"></div>
  </main>
  <script>
    const owner = "CryoFrozen";  // Replace with your GitHub username/org
    const repo = "CryoExtensions";       // Replace with your GitHub repo name
    const folderPath = "extensions";  // Root folder containing extension folders

    const extensionsContainer = document.getElementById('extensionsContainer');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const searchBar = document.getElementById('searchBar');
    const spinner = document.querySelector('.spinner');
    const logo = document.getElementById('logo');

    let extensionsData = []; // To hold loaded extensions info
    let getMethod = 'download'; // default method
    let iconUrl = ''; // To store the icon URL from GitHub

    // Fetch icon from GitHub repository root
    async function fetchIcon() {
      try {
        const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/`;
        const response = await fetchJson(apiUrl);
        const iconFile = response.find(file => file.name.toLowerCase() === "icon.png");
        if (iconFile) {
          iconUrl = iconFile.download_url;
          logo.src = iconUrl; // Set logo image source
          const link = document.querySelector('link[rel="icon"]');
          if (link) link.href = iconUrl; // Set favicon source
          console.log('Icon loaded from:', iconUrl);
        } else {
          console.log('Icon.png not found in repository root');
          logo.src = 'https://via.placeholder.com/40'; // Fallback placeholder
          const link = document.querySelector('link[rel="icon"]');
          if (link) link.href = 'https://via.placeholder.com/40';
        }
      } catch (error) {
        console.error('Error fetching icon:', error);
        logo.src = 'https://via.placeholder.com/40'; // Fallback placeholder
        const link = document.querySelector('link[rel="icon"]');
        if (link) link.href = 'https://via.placeholder.com/40';
      }
    }

    // Toggle settings panel visibility
    settingsBtn.addEventListener('click', () => {
      settingsPanel.style.display = settingsPanel.style.display === 'block' ? 'none' : 'block';
    });

    // Close settings panel if clicked outside
    window.addEventListener('click', e => {
      if (!settingsPanel.contains(e.target) && e.target !== settingsBtn) {
        settingsPanel.style.display = 'none';
      }
    });

    // Handle settings radio changes
    settingsPanel.querySelectorAll('input[name="getMethod"]').forEach(radio => {
      radio.addEventListener('change', e => {
        getMethod = e.target.value;
        renderExtensions(extensionsData);
      });
    });

    // Utility fetch helpers
    async function fetchJson(url) {
      const res = await fetch(url, {
        headers: {
          'Accept': 'application/vnd.github.v3+json'
        }
      });
      if (!res.ok) throw new Error(`HTTP error ${res.status}: ${await res.text()}`);
      return res.json();
    }

    async function fetchText(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP error ${res.status}`);
      return res.text();
    }

    // Load all extensions
    async function loadExtensions() {
      spinner.classList.remove('hidden');
      const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${folderPath}`;
      try {
        console.log('Fetching extensions from:', apiUrl);
        const folders = await fetchJson(apiUrl);
        const extensionFolders = folders.filter(item => item.type === "dir");

        const loadedExtensions = [];

        for (const folder of extensionFolders) {
          console.log('Processing folder:', folder.name);
          const folderContents = await fetchJson(folder.url);

          const jsFile = folderContents.find(f => f.name.endsWith(".js"));
          const txtFile = folderContents.find(f => f.name.endsWith(".txt"));
          const thumbFile = folderContents.find(f => f.name.toLowerCase() === "thumbnail.png");

          let description = "No description available.";
          if (txtFile) {
            try {
              description = await fetchText(txtFile.download_url);
            } catch (err) {
              console.warn(`Failed to fetch description for ${folder.name}:`, err);
            }
          }

          let jsContent = null;
          if (jsFile) {
            try {
              jsContent = await fetchText(jsFile.download_url);
            } catch (err) {
              console.warn(`Failed to fetch JS content for ${folder.name}:`, err);
            }
          }

          loadedExtensions.push({
            folderName: folder.name,
            description,
            thumbnailUrl: thumbFile ? thumbFile.download_url : null,
            jsFileUrl: jsFile ? jsFile.download_url : null,
            jsFileName: jsFile ? jsFile.name : null,
            jsContent
          });
        }

        extensionsData = loadedExtensions;
        renderExtensions(extensionsData);
        console.log('Extensions loaded:', extensionsData.length);

      } catch (error) {
        console.error("Error loading extensions:", error);
        extensionsContainer.innerHTML = `<p style="color:red;">Failed to load extensions: ${error.message}</p>`;
      } finally {
        spinner.classList.add('hidden');
      }
    }

    // Render filtered extensions
    function renderExtensions(data) {
      const searchTerm = searchBar.value.trim().toLowerCase();

      extensionsContainer.innerHTML = '';

      const filtered = data.filter(ext => 
        ext.folderName.toLowerCase().includes(searchTerm) ||
        ext.description.toLowerCase().includes(searchTerm)
      );

      if (filtered.length === 0) {
        extensionsContainer.innerHTML = `<p>No extensions found.</p>`;
        return;
      }

      filtered.forEach(ext => {
        const card = document.createElement('div');
        card.className = 'extension-card';

        if (ext.thumbnailUrl) {
          const img = document.createElement('img');
          img.className = 'thumbnail';
          img.src = ext.thumbnailUrl;
          img.alt = `${ext.folderName} thumbnail`;
          card.appendChild(img);
        }

        const desc = document.createElement('div');
        desc.className = 'description';
        desc.textContent = ext.description;
        card.appendChild(desc);

        const btn = document.createElement('button');
        btn.className = 'action-btn';
        btn.textContent = ext.jsFileName ? `Get ${ext.jsFileName}` : 'No JS File';
        btn.setAttribute('aria-label', 'Get extension file');

        if (!ext.jsFileUrl) {
          btn.disabled = true;
        } else {
          btn.addEventListener('click', async () => {
            try {
              if (getMethod === 'download') {
                const response = await fetch(ext.jsFileUrl);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = ext.jsFileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
              } else if (getMethod === 'copyContent') {
                if (ext.jsContent) {
                  await navigator.clipboard.writeText(ext.jsContent);
                  alert(`JS content from ${ext.jsFileName} copied to clipboard!`);
                } else {
                  alert('JS content not available to copy.');
                }
              } else if (getMethod === 'copyUrl') {
                window.open(ext.jsFileUrl, '_blank');
              }
            } catch (err) {
              alert(`Error: ${err.message}`);
            }
          });
        }

        card.appendChild(btn);
        extensionsContainer.appendChild(card);
      });
    }

    searchBar.addEventListener('input', () => {
      renderExtensions(extensionsData);
    });

    // Load icon and extensions on page start
    (async () => {
      await fetchIcon();
      await loadExtensions();
    })();
  </script>
</body>
</html>